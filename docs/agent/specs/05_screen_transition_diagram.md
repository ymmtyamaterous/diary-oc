# 画面遷移図

## 1. 概要

日記アプリケーション (Diary Open Close) の画面遷移とユーザーフローを定義する。  
フロントエンドは Next.js (App Router) を使用しており、各ページは独立したルートとして管理される。

---

## 2. 画面遷移図（全体）

```
                    ┌──────────────────┐
                    │  アプリ起動       │
                    │  /               │
                    └────────┬─────────┘
                             │
                    ┌────────▼─────────┐
                    │  認証状態チェック  │
                    │  (middleware.ts)  │
                    └────────┬─────────┘
                             │
              ┌──────────────┴──────────────┐
              │                             │
         未認証                          認証済み
              │                             │
    ┌─────────▼─────────┐         ┌─────────▼─────────┐
    │  SC-001            │         │  SC-003           │
    │  /login            │         │  /diary           │
    │  ログイン画面       │         │  マイ日記画面      │
    └─────────┬──────────┘         └─────────┬─────────┘
              │                             │
              │  ログイン成功               │  ナビゲーション
              │                             │
    ┌─────────▼──────────┐         ┌────────▼──────────┐
    │  SC-003             │         │  SC-004           │
    │  /diary             │         │  /public          │
    │  マイ日記画面        │         │  みんなの日記画面  │
    └─────────────────────┘         └───────────────────┘
              ▲                             │
              │  ナビゲーション               │  ナビゲーション
              └─────────────────────────────┘

    ┌─────────────────────┐
    │  SC-002             │
    │  /register          │
    │  ユーザー登録画面    │
    └─────────────────────┘
    ※ /login ↔ /register は相互リンク
```

---

## 3. 画面別遷移詳細

### 3.1 ルートパス (`/`)

```
┌─────────────────────────────────┐
│  / (ルートパス)                  │
│  middleware.ts で認証状態確認    │
└─────────────┬───────────────────┘
              │
    ┌─────────┼─────────┐
    │                   │
  認証済み            未認証
    │                   │
    ▼                   ▼
 /diary              /login
 (リダイレクト)       (リダイレクト)
```

---

### 3.2 SC-001: ログイン画面 (`/login`)

```
┌─────────────────────────────────┐
│  SC-001: /login                  │
│  (認証済みなら /diary へ redirect) │
└─────────────┬───────────────────┘
              │
              │ ユーザー操作
              │
    ┌─────────┼─────────┐
    │                   │
[ログイン         [新規登録リンク]
 ボタン]                 │
    │                   ▼
    ▼               SC-002:
  POST               /register
  /api/auth/login
    │
    ├─ 成功 ──────────▶ SC-003: /diary
    │
    └─ 失敗 ──────────▶ エラーメッセージ表示
                         (同画面に留まる)
```

#### 遷移トリガー
| トリガー | 遷移先 | 条件 |
|---------|--------|------|
| ログインボタンクリック → 成功 | SC-003 (`/diary`) | 認証成功、JWTトークン取得 |
| ログインボタンクリック → 失敗 | SC-001 (`/login`) | 認証失敗、エラーメッセージ表示 |
| 新規登録リンク | SC-002 (`/register`) | なし |
| みんなの日記ボタン | SC-004 (`/public`) | なし |

---

### 3.3 SC-002: ユーザー登録画面 (`/register`)

```
┌─────────────────────────────────┐
│  SC-002: /register               │
│  (認証済みなら /diary へ redirect) │
└─────────────┬───────────────────┘
              │
              │ ユーザー操作
              │
    ┌─────────┼─────────┐
    │                   │
[登録ボタン]       [ログインリンク]
    │                   │
    ▼                   ▼
  POST              SC-001:
  /api/auth/register  /login
    │
    ├─ 成功 ──────────▶ SC-003: /diary
    │
    └─ 失敗 ──────────▶ エラーメッセージ表示
                         (同画面に留まる)
```

#### 遷移トリガー
| トリガー | 遷移先 | 条件 |
|---------|--------|------|
| 登録ボタンクリック → 成功 | SC-003 (`/diary`) | 登録成功、JWTトークン取得 |
| 登録ボタンクリック → 失敗 | SC-002 (`/register`) | バリデーションエラー・メール重複 |
| ログインリンク | SC-001 (`/login`) | なし |

---

### 3.4 SC-003: マイ日記画面 (`/diary`)

```
┌─────────────────────────────────┐
│  SC-003: /diary                  │
│  (未認証なら /login へ redirect)  │
└─────────────┬───────────────────┘
              │
              │ ユーザー操作
              │
    ┌─────────┼─────────┬─────────┬─────────┐
    │         │         │         │         │
[日記作成]  [日記削除] [公開設定] [みんなの] [ログアウト]
    │         │       切り替え    日記       │
    │         │         │         │         │
    ▼         ▼         ▼         ▼         ▼
  POST      確認     PATCH      SC-004:  JWTトークン
  /api/     モーダル  /api/      /public   削除
  diaries   表示     diaries/           │
    │         │       :id/             ▼
    │         ▼       visibility    SC-001:
    │       DELETE                  /login
    │       /api/
    │       diaries/:id
    │
    └─ すべてのアクション後
       → 日記一覧を再フェッチして表示更新
```

#### 遷移トリガー
| トリガー | 遷移先 | 条件 |
|---------|--------|------|
| 日記作成フォーム送信 → 成功 | SC-003 (同画面、一覧更新) | バリデーション成功、API成功 |
| 削除ボタン → 確認 → 削除実行 → 成功 | SC-003 (同画面、一覧更新) | API成功 |
| 公開設定切り替え → 成功 | SC-003 (同画面、状態更新) | API成功 |
| みんなの日記ボタン | SC-004 (`/public`) | なし |
| ログアウトボタン | SC-001 (`/login`) | JWTトークン削除後 |

#### 内部状態変化（遷移なし）
| アクション | 動作 |
|-----------|------|
| 日付選択（カレンダー） | フォーム内の日付フィールド更新 |
| 天気選択 | フォーム内の天気フィールド更新 |
| 画像選択 | プレビュー表示（アップロードAPI呼び出し） |
| 音声選択 | 再生コントロール表示（アップロードAPI呼び出し） |
| 詳細項目入力 | フォーム内の各フィールド更新 |

---

### 3.5 SC-004: みんなの日記画面 (`/public`)

```
┌─────────────────────────────────┐
│  SC-004: /public                 │
│  (認証不要、全ユーザー閲覧可能)   │
└─────────────┬───────────────────┘
              │
              │ ユーザー操作
              │
    ┌─────────┼─────────┐
    │                   │
[マイ日記ボタン]    [ログイン/ログアウト
    │                   ボタン]
    │                       │
    ▼                       ├─ 認証済み → ログアウト
  認証済み?                  │
    YES → SC-003: /diary    └─ 未認証  → SC-001: /login
    NO  → SC-001: /login
```

#### 遷移トリガー
| トリガー | 遷移先 | 条件 |
|---------|--------|------|
| マイ日記ボタン（認証済み） | SC-003 (`/diary`) | JWTトークンあり |
| マイ日記ボタン（未認証） | SC-001 (`/login`) | JWTトークンなし |
| ログインボタン（未認証時のみ） | SC-001 (`/login`) | JWTトークンなし |

---

## 4. ユーザーフロー

### 4.1 初回訪問（未認証ユーザー）

```
START
  │
  ▼
アプリ起動 (/)
  │
  ▼ middleware でリダイレクト
SC-001: /login
  │
  ├─→ [みんなの日記を見る]
  │     │
  │     ▼
  │   SC-004: /public
  │     │
  │     └─→ [マイ日記を見たい]
  │           │
  │           ▼
  │         SC-001: /login
  │
  ├─→ [新規登録はこちら]
  │     │
  │     ▼
  │   SC-002: /register
  │     │
  │     ▼
  │   登録成功
  │     │
  │     ▼
  │   SC-003: /diary
  │
  └─→ [ログイン]
        │
        ▼
      POST /api/auth/login
        │
        ▼ JWTトークン保存
      SC-003: /diary
        │
        ▼
      END（継続利用）
```

---

### 4.2 日記作成フロー（認証済みユーザー）

```
START (SC-003: /diary)
  │
  ▼
日記作成フォーム入力
  │
  ├─→ 日付選択（カレンダー）
  ├─→ 天気選択
  ├─→ メインコンテンツ入力
  ├─→ 詳細項目入力（10項目）
  ├─→ 画像選択（任意）
  │     │
  │     ▼ POST /api/upload/image
  │   画像URL取得
  ├─→ 音声選択（任意）
  │     │
  │     ▼ POST /api/upload/audio
  │   音声URL取得
  └─→ 公開設定選択
  │
  ▼
[保存する]ボタンクリック
  │
  ▼
バリデーション（クライアント側）
  │
  ├─NG → エラーメッセージ表示
  │         └─→ フォームに戻る
  │
  OK
  │
  ▼
POST /api/diaries
  │
  ├─ 失敗 → エラーメッセージ表示
  │           └─→ フォームに戻る
  │
  成功
  │
  ▼
成功メッセージ表示
  │
  ▼
フォームクリア
  │
  ▼
GET /api/diaries で日記一覧を再フェッチ
  │
  ▼
END
```

---

### 4.3 日記削除フロー

```
START (SC-003: /diary)
  │
  ▼
日記エントリーの[削除]ボタンクリック
  │
  ▼
確認モーダル表示（背景: bg-black/50）
「この日記を削除しますか？」
  │
  ├─→ [キャンセル]
  │     │
  │     ▼
  │   モーダル閉じる → END
  │
  └─→ [削除する]
        │
        ▼
      DELETE /api/diaries/:id
        │
        ├─ 失敗 → エラーメッセージ表示 → END
        │
        成功（サーバー側でファイルも削除）
        │
        ▼
      GET /api/diaries で日記一覧を再フェッチ
        │
        ▼
      END
```

---

### 4.4 公開設定切り替えフロー

```
START (SC-003: /diary)
  │
  ▼
日記エントリーの[公開/非公開切替]ボタンクリック
  │
  ▼
PATCH /api/diaries/:id/visibility
  │
  ├─ 失敗 → エラーメッセージ表示 → END
  │
  成功
  │
  ▼
ボタンのラベルと表示を即座に更新
  │
  ▼
END
```

---

## 5. エラーハンドリングフロー

### 5.1 ネットワーク・APIエラー

```
任意のAPI呼び出し
  │
  ▼
レスポンス確認
  │
  ├─ 成功 (2xx) ─→ 正常処理続行
  │
  └─ 失敗
      │
      ▼
    ステータスコード判定
      │
      ├─ 401 Unauthorized
      │   └─→ JWTトークン削除 → /login へリダイレクト
      │
      ├─ 403 Forbidden
      │   └─→ 「権限がありません」メッセージ表示
      │
      ├─ 404 Not Found
      │   └─→ 「リソースが見つかりません」メッセージ表示
      │
      ├─ 400 Bad Request
      │   └─→ レスポンスのエラーメッセージを表示
      │
      └─ 500 / ネットワークエラー
          └─→ 「接続に失敗しました」メッセージ表示
      │
      ▼
    現在の画面に留まる（または再試行ボタン表示）
```

### 5.2 認証エラー（ミドルウェア）

```
認証が必要なページへのアクセス
  │
  ▼
Next.js middleware.ts で JWTトークン確認
  │
  ├─ トークンあり・有効 ─→ ページ表示
  │
  └─ トークンなし・無効・期限切れ
      │
      ▼
    /login へリダイレクト
```

---

## 6. 状態管理

### 6.1 グローバル状態（Context または状態管理ライブラリ）

| 状態 | 型 | 説明 | 管理場所 |
|------|---|------|---------|
| `user` | `User \| null` | 現在のログインユーザー | AuthContext |
| `token` | `string \| null` | JWTトークン | AuthContext + localStorage |
| `isLoading` | `boolean` | 認証状態の確認中 | AuthContext |

### 6.2 ページローカル状態

#### `/diary` ページ
- `entries`: 自分の日記一覧
- `isLoadingEntries`: 日記データの取得中
- `formState`: 日記作成フォームの各フィールド値
- `isSubmitting`: フォーム送信中
- `error`: エラーメッセージ

#### `/public` ページ
- `publicEntries`: 公開日記一覧
- `isLoading`: データ取得中
- `error`: エラーメッセージ

---

## 7. Next.js ルーティング・認証制御

### 7.1 ミドルウェアによる認証ガード

`middleware.ts` で保護されたルートへのアクセスを制御する。

```typescript
// 保護されたルート（認証必須）
const protectedRoutes = ['/diary'];

// 認証済みユーザーがアクセス不可なルート
const authRoutes = ['/login', '/register'];
```

### 7.2 ページ構成（App Router）

```
app/
├── layout.tsx          # 共通レイアウト（ヘッダー等）
├── page.tsx            # / → /diary または /login へリダイレクト
├── login/
│   └── page.tsx        # SC-001
├── register/
│   └── page.tsx        # SC-002
├── diary/
│   └── page.tsx        # SC-003
└── public/
    └── page.tsx        # SC-004
```

---

**文書作成日**: 2026年2月19日  
**バージョン**: 1.0
