# 非機能要件定義書

## 1. 概要

本文書は日記アプリケーション (Diary Open Close) の非機能要件を定義する。非機能要件とは、システムの品質特性や制約条件など、機能以外の要求事項を指す。

---

## 2. パフォーマンス要件

### 2.1 レスポンスタイム

| 操作 | 目標レスポンスタイム | 最大許容時間 | 測定条件 |
|------|-------------------|------------|---------|
| 画面初期表示 | 1秒以内 | 3秒 | 通常のネットワーク環境 |
| 日記一覧取得 | 1秒以内 | 3秒 | 最大100エントリー |
| 日記作成・保存 | 2秒以内 | 5秒 | 画像・音声なし |
| 画像アップロード | 3秒以内 | 10秒 | 5MB以下の画像 |
| 音声アップロード | 5秒以内 | 15秒 | 10MB以下の音声 |
| 日記削除 | 1秒以内 | 3秒 | ファイル含む |
| 公開設定切り替え | 1秒以内 | 2秒 | - |
| ページ遷移（クライアントサイド） | 0.3秒以内 | 1秒 | Next.js Link コンポーネント使用 |

### 2.2 スループット

| 項目 | 要件 |
|------|------|
| 同時接続ユーザー数 | 最大100ユーザー（初期想定） |
| APIリクエスト処理能力 | Goの標準的な並行処理性能に準ずる |

### 2.3 データ量

| 項目 | 制限値 | 備考 |
|------|--------|------|
| 日記エントリー数 | 制限なし | ユーザーあたり |
| 画像ファイルサイズ | 最大5MB | 1エントリーあたり1ファイル |
| 音声ファイルサイズ | 最大10MB | 1エントリーあたり1ファイル |
| テキストフィールド | 制限なし（PostgreSQL TEXT型） | 実用上は10,000文字程度を想定 |
| 公開日記取得件数 | 50件 | 最新から順に |

---

## 3. 可用性要件

### 3.1 稼働時間

| 項目 | 目標値 | 備考 |
|------|--------|------|
| 稼働率 | 99%以上 | メンテナンス時間を除く |
| 計画メンテナンス | 月1回、最大2時間 | 事前通知あり |
| 緊急メンテナンス | 必要に応じて実施 | 可能な限り事前通知 |

### 3.2 障害復旧

| 項目 | 目標値 |
|------|--------|
| RTO（Recovery Time Objective） | 4時間以内 |
| RPO（Recovery Point Objective） | 24時間以内 |

### 3.3 冗長化

| コンポーネント | 冗長化方針 |
|-------------|----------|
| PostgreSQL | 単一構成（初期）、将来的にレプリカ構成 |
| Goバックエンド | 単一構成（初期）、将来的に複数インスタンス化 |
| Next.jsフロントエンド | 単一構成（初期） |
| ファイルストレージ | 単一構成（初期）、バックアップ推奨 |

---

## 4. セキュリティ要件

### 4.1 認証・認可

| 項目 | 要件 |
|------|------|
| 認証方式 | JWT (JSON Web Token) |
| パスワード保護 | bcryptによるハッシュ化 |
| トークン管理 | クライアントのlocalStorageまたはhttpOnly Cookie |
| トークン有効期限 | 24時間（設定可能） |
| 認可制御 | バックエンドAPIレベルでユーザーID確認 |

### 4.2 データアクセス制御

| データ | 読み取り権限 | 書き込み権限 |
|--------|------------|------------|
| 自分の日記（非公開） | 本人のみ | 本人のみ |
| 自分の日記（公開） | 全ユーザー | 本人のみ |
| 他人の日記（公開） | 全ユーザー | 不可 |
| 他人の日記（非公開） | 不可 | 不可 |

> **実装**: バックエンドの各APIで `user_id = JWTのsubject` を照合して強制する

### 4.3 通信セキュリティ

| 項目 | 要件 |
|------|------|
| プロトコル | HTTPS（本番環境） |
| 証明書 | SSL/TLS証明書（本番環境） |
| CORS | `ALLOWED_ORIGINS` 環境変数で指定したオリジンのみ許可 |

### 4.4 入力検証

| 項目 | 検証内容 |
|------|---------|
| ファイルアップロード | MIME type、ファイルサイズ、拡張子 |
| パストラバーサル | ファイルパスの検証（`UPLOAD_DIR` 外アクセス防止） |
| SQLインジェクション | Goのprepared statement（`database/sql`）による自動対策 |
| XSS | Next.jsによる自動エスケープ |
| パスワード | 8文字以上のバリデーション |

### 4.5 クレデンシャル管理

| 項目 | 要件 |
|------|------|
| 環境変数 | `JWT_SECRET`, `DATABASE_URL` 等は `.env` ファイルで管理 |
| Gitへの除外 | `.env` ファイルは `.gitignore` に追加 |
| JWTシークレット | 本番環境では十分な長さのランダム文字列を使用 |

---

## 5. スケーラビリティ要件

### 5.1 垂直スケーリング

| コンポーネント | スケーリング方針 |
|-------------|---------------|
| PostgreSQL | コンテナリソース（CPU/メモリ）の増強 |
| Goバックエンド | コンテナリソースの増強（Goは軽量なため効果大） |

### 5.2 水平スケーリング

| コンポーネント | スケーリング方針 |
|-------------|---------------|
| Goバックエンド | 複数インスタンス化、ロードバランサー追加（将来） |
| PostgreSQL | Read Replicaの追加（将来） |
| ファイルストレージ | クラウドストレージ移行（将来） |

### 5.3 スケーラビリティ目標

| フェーズ | ユーザー数 | 必要な対応 |
|---------|----------|----------|
| フェーズ1（初期） | ~100ユーザー | 現状のdevcontainer構成 |
| フェーズ2 | ~1,000ユーザー | PostgreSQL最適化、インデックス見直し |
| フェーズ3 | ~10,000ユーザー | CDN導入、ストレージのクラウド化、Read Replica |

---

## 6. 保守性要件

### 6.1 ログ

| ログレベル | 出力内容 |
|----------|---------|
| INFO | 正常な処理（アップロード成功、削除成功、起動ログなど） |
| WARN | 警告（バリデーション失敗、認証失敗など） |
| ERROR | エラー情報（アップロード失敗、DB接続エラーなど） |

### 6.2 ログ出力先

| 環境 | 出力先 |
|------|--------|
| 開発環境（Air） | コンソール（標準出力） |
| 本番環境 | ファイル + 集中ログ管理システム（将来） |

### 6.3 監視

| 監視項目 | 監視方法 | アラート条件 |
|---------|---------|------------|
| APIサーバー稼働状態 | ヘルスチェックエンドポイント（`GET /api/health`） | 3回連続失敗 |
| ディスク使用率 | システムモニタリング | 80%以上 |
| PostgreSQL接続 | ヘルスチェック内でDB疎通確認 | 接続失敗時 |

### 6.4 バックアップ

| 対象 | 頻度 | 保持期間 | 方法 |
|------|------|---------|------|
| PostgreSQLデータ | 日次 | 30日間 | pg_dump によるバックアップ |
| アップロードファイル | 週次 | 90日間 | ファイルシステムバックアップ |
| 設定ファイル | Git管理 | 無期限 | GitHubリポジトリ |

### 6.5 ホットリロード（開発環境）

- バックエンドは **Air** を使用してホットリロードを実現
- Goソースコードの変更を検知して自動リビルド・再起動
- Air設定ファイル: `backend/.air.toml`

---

## 7. 互換性要件

### 7.1 ブラウザ互換性

| ブラウザ | バージョン | 対応状況 |
|---------|----------|---------|
| Google Chrome | 最新版 | フルサポート |
| Firefox | 最新版 | フルサポート |
| Safari | 最新版 | フルサポート |
| Microsoft Edge | 最新版 | フルサポート |
| IE11 | - | 非対応 |

### 7.2 デバイス対応

| デバイス | 対応状況 | 備考 |
|---------|---------|------|
| デスクトップPC | フルサポート | 推奨解像度: 1920x1080以上 |
| タブレット | 基本サポート | TailwindCSS レスポンシブ対応 |
| スマートフォン | 基本サポート | TailwindCSS レスポンシブ対応 |

### 7.3 OS互換性

| OS | サポート状況 |
|----|------------|
| Windows 10/11 | フルサポート |
| macOS | フルサポート |
| Linux (Ubuntu 24.04) | フルサポート（devcontainer環境） |
| iOS | 基本サポート（ブラウザ経由） |
| Android | 基本サポート（ブラウザ経由） |

---

## 8. ユーザビリティ要件

### 8.1 レスポンシブデザイン

| 画面サイズ | TailwindCSSプレフィックス | 対応内容 |
|-----------|------------------------|---------|
| デスクトップ | `lg:` (1024px以上) | フル機能 |
| タブレット | `md:` (768px - 1023px) | レイアウト調整 |
| モバイル | `sm:` (640px以下) | コンパクト表示 |

### 8.2 アクセシビリティ

| 項目 | 要件 |
|------|------|
| キーボード操作 | すべての操作がキーボードで可能 |
| スクリーンリーダー | 主要機能で対応（`aria-label` 等） |
| カラーコントラスト | WCAG 2.1 AA準拠（目標） |
| フォントサイズ | 最小14px |

### 8.3 国際化

| 項目 | 現状 | 将来対応 |
|------|------|---------|
| 言語 | 日本語のみ | 英語、中国語など |
| タイムゾーン | JST固定 | ユーザー設定可能 |
| 日付形式 | 日本式（YYYY年MM月DD日） | ロケールに応じた表示 |

---

## 9. データ要件

### 9.1 データ保持

| データ種別 | 保持期間 | 削除方針 |
|-----------|---------|---------|
| 日記エントリー | 無期限 | ユーザーによる削除のみ |
| アップロードファイル | 無期限 | エントリー削除時に連動削除 |
| ユーザー情報 | 無期限 | アカウント削除時に削除（将来実装） |
| JWTトークン | 有効期限まで | クライアント側で管理 |

### 9.2 データ整合性

| 項目 | 要件 |
|------|------|
| 参照整合性 | PostgreSQL外部キー制約（`ON DELETE CASCADE`）で保証 |
| トランザクション | 日記削除時はDB削除後にファイル削除（ベストエフォート） |
| マイグレーション | Go CLIコマンドで管理（`backend/migrations/`） |

---

## 10. 運用要件

### 10.1 デプロイメント

| 項目 | 要件 |
|------|------|
| デプロイ方式 | Docker Compose（devcontainer） |
| デプロイ頻度 | 週1回（通常）、必要に応じて随時 |
| ロールバック | 前バージョンへの切り戻し可能（Gitによるコード管理） |
| ダウンタイム | 最小化（目標: 5分以内） |

### 10.2 環境

| 環境 | 用途 | 更新タイミング |
|------|------|--------------|
| 開発環境（devcontainer） | 開発・テスト | 随時（Air によるホットリロード） |
| 本番環境 | ユーザー提供 | 週次または必要時 |

### 10.3 環境変数管理

本番環境を考慮して以下の値は必ず環境変数から設定する：

| 環境変数 | 説明 |
|---------|------|
| `HOST` | バインドするホストアドレス |
| `API_PORT` | APIサーバーのポート番号 |
| `ALLOWED_ORIGINS` | CORS許可オリジン（カンマ区切り） |
| `DATABASE_URL` | PostgreSQL接続文字列 |
| `JWT_SECRET` | JWT署名シークレットキー |
| `UPLOAD_DIR` | ファイルアップロードディレクトリ |

---

## 11. テスト要件

### 11.1 テスト種別

| テスト種別 | 実施タイミング | カバレッジ目標 |
|-----------|--------------|--------------|
| 単体テスト | コミット前 | 70%以上 |
| 結合テスト | PR前 | 主要機能100% |
| E2Eテスト | リリース前 | 主要シナリオ100% |
| セキュリティテスト | リリース前 | 全エンドポイント |

### 11.2 テストツール

| テスト種別 | ツール | 備考 |
|-----------|--------|------|
| バックエンド単体テスト | Go 標準 `testing` パッケージ | `go test ./...` |
| フロントエンド単体テスト | Jest / Vitest + React Testing Library | 将来導入 |
| E2Eテスト | Playwright | 将来導入 |
| APIテスト | Go `net/http/httptest` | バックエンドの結合テスト |

---

## 12. コンプライアンス要件

### 12.1 個人情報保護

| 項目 | 要件 |
|------|------|
| 収集する個人情報 | メールアドレス、表示名（ユーザーが入力） |
| 利用目的 | アプリケーションの認証・識別のみ |
| 第三者提供 | なし |
| パスワード | bcryptハッシュ化して保存（生パスワードは保存しない） |

---

## 13. 開発・技術要件

### 13.1 技術スタック

| レイヤー | 技術 | バージョン |
|---------|------|----------|
| フロントエンド | Next.js (App Router) | 16.x |
| 言語（フロント） | TypeScript | 5.x |
| スタイリング | TailwindCSS | v4 |
| バックエンド | Go | 1.25.x |
| ホットリロード | Air | 最新版 |
| データベース | PostgreSQL | 18.x |
| コンテナ | Docker Compose | 2.x |
| 実行環境 | Ubuntu 24.04 (devcontainer) | - |

### 13.2 コーディング規約

#### フロントエンド（TypeScript / Next.js）
| 項目 | 要件 |
|------|------|
| 型定義 | `any` 型の使用禁止。具体的な型を定義すること |
| Null安全 | APIレスポンスが `null` / `undefined` の場合にエラーが発生しないように実装 |
| リンター | ESLint |
| 命名規則 | camelCase（変数・関数）、PascalCase（コンポーネント・型） |
| モーダル背景 | `bg-black/50` クラスで半透明指定 |

#### バックエンド（Go）
| 項目 | 要件 |
|------|------|
| エラーハンドリング | Goの慣用的なエラーハンドリング（`if err != nil`） |
| 命名規則 | Go標準規約に準拠（`camelCase`、`PascalCase`） |
| API定義 | `backend/openapi.yaml` で一元管理 |
| マイグレーション | `backend/migrations/` 配下にSQLファイルを配置し、Go CLIで管理 |

### 13.3 バージョン管理

| 項目 | 要件 |
|------|------|
| VCS | Git |
| ブランチ戦略 | Git Flow（または簡略版） |
| コミットメッセージ | Conventional Commits推奨 |
| コードレビュー | Pull Request必須（将来） |

---

## 14. 制約事項

### 14.1 技術的制約

| 項目 | 制約内容 |
|------|---------|
| ファイルストレージ | ローカルファイルシステム（`UPLOAD_DIR` 配下）。スケール時はクラウド移行が必要 |
| devcontainer | `psql` / `docker` コマンドは直接使用不可 |
| 実行ユーザー | devcontainer 内は `vscode` ユーザーで動作 |

### 14.2 運用上の制約

| 項目 | 制約内容 |
|------|---------|
| サポート時間 | ベストエフォート（専任なし） |
| メンテナンス | 事前通知なしの場合あり（初期段階） |

---

## 15. 非機能要件の優先順位

| 順位 | 要件カテゴリ | 理由 |
|------|-----------|------|
| 1 | セキュリティ | ユーザーデータ・認証情報の保護が最重要 |
| 2 | パフォーマンス | ユーザー体験に直結 |
| 3 | 可用性 | サービス継続性 |
| 4 | 保守性 | 長期運用のため |
| 5 | スケーラビリティ | 将来の成長に備えて |

---

**文書作成日**: 2026年2月19日  
**バージョン**: 1.0
