# 機能仕様書

## 1. システム概要

### 1.1 システム名
日記アプリケーション (Diary Open Close)

### 1.2 システムの目的
ユーザーが日々の出来事や感情、気づきなどを記録し、振り返ることができる日記アプリケーションを提供する。画像や音声の添付、天気情報の記録、詳細な項目別入力、公開/非公開設定など、豊富な機能を備えている。

### 1.3 対象ユーザー
- 日記を習慣化したい個人ユーザー
- 日々の振り返りを行いたいユーザー
- 他のユーザーと日記を共有したいユーザー

---

## 2. 機能一覧

### 2.1 認証機能

#### 2.1.1 ユーザー登録
- **機能ID**: AUTH-001
- **機能名**: メールアドレス・パスワードによるユーザー登録
- **説明**: ユーザーはメールアドレスとパスワードを使用して新規アカウントを登録できる
- **入力項目**:
  - メールアドレス
  - パスワード
  - 表示名
- **主な処理**:
  - 入力値のバリデーション
  - パスワードのハッシュ化（bcrypt）
  - ユーザー情報のDBへの保存
  - JWTトークンの発行
- **アクセス権**: 未認証ユーザー

#### 2.1.2 ログイン
- **機能ID**: AUTH-002
- **機能名**: メールアドレス・パスワードによるログイン
- **説明**: 登録済みのメールアドレスとパスワードでアプリケーションにログインできる
- **主な処理**:
  - 入力値のバリデーション
  - パスワードの照合
  - JWTアクセストークンの発行
  - トークンをブラウザのlocalStorage（またはhttpOnly Cookie）に保存
- **アクセス権**: 未認証ユーザー

#### 2.1.3 ログアウト
- **機能ID**: AUTH-003
- **機能名**: ログアウト機能
- **説明**: ログイン中のユーザーがアプリケーションからログアウトできる
- **主な処理**:
  - クライアント側のJWTトークン削除
  - ローカルセッションのクリア
- **アクセス権**: 認証済みユーザー

#### 2.1.4 認証状態確認
- **機能ID**: AUTH-004
- **機能名**: 現在のログインユーザー情報取得
- **説明**: JWTトークンを検証し、現在ログインしているユーザーの情報を取得する
- **主な処理**:
  - JWTトークンの検証
  - ユーザー情報の返却
- **アクセス権**: 認証済みユーザー

---

### 2.2 日記作成機能

#### 2.2.1 基本日記入力
- **機能ID**: DIARY-001
- **機能名**: 日記エントリー作成
- **説明**: ユーザーが日記エントリーを作成できる
- **入力項目**:
  - メインコンテンツ（テキストエリア）
  - 日付（カレンダー選択）
  - 天気（8種類のオプションから選択）
    - 晴れ ☀️
    - 曇り ☁️
    - 雨 🌧️
    - 雪 ❄️
    - 嵐 ⛈️
    - 霧 🌫️
    - 晴れ時々曇り ⛅
    - 風が強い 💨
  - 公開設定（公開/非公開）
- **バリデーション**:
  - 少なくとも1つの項目が入力されていること
- **アクセス権**: 認証済みユーザー

#### 2.2.2 詳細項目入力
- **機能ID**: DIARY-002
- **機能名**: 10項目の詳細フィールド入力
- **説明**: 構造化された10の項目に沿って詳細な日記を記録できる
- **詳細項目**:
  1. **出来事** (events) - 今日起きた出来事
  2. **感情** (emotions) - 今日の気持ちや感情
  3. **よかったこと** (good_things) - 今日よかったこと
  4. **反省点** (reflections) - 今日の反省点や改善したいこと
  5. **感謝したこと** (gratitude) - 今日感謝したこと
  6. **明日の目標** (tomorrow_goals) - 明日の目標
  7. **明日の楽しみ** (tomorrow_looking_forward) - 明日楽しみにしていること
  8. **学んだこと・気づき** (learnings) - 今日学んだことや気づき
  9. **健康・習慣チェック** (health_habits) - 運動、食事、睡眠などの健康管理
  10. **今日を一言で表すなら** (today_in_one_word) - 今日という日を一言で表現
- **アクセス権**: 認証済みユーザー

#### 2.2.3 画像アップロード
- **機能ID**: DIARY-003
- **機能名**: 画像ファイル添付
- **説明**: 日記エントリーに画像ファイルを添付できる
- **制約**:
  - ファイルタイプ: 画像ファイル（image/*）のみ
  - 最大ファイルサイズ: 5MB
  - アップロード数: 1ファイル/エントリー
- **処理フロー**:
  1. クライアントでファイル選択
  2. バックエンドAPIへアップロード（JWTトークン付き）
  3. サーバー側でファイル保存（`UPLOAD_DIR`配下）
  4. URLをDBに保存
- **アクセス権**: 認証済みユーザー

#### 2.2.4 音声アップロード
- **機能ID**: DIARY-004
- **機能名**: 音声ファイル添付
- **説明**: 日記エントリーに音声ファイルを添付できる
- **対応フォーマット**:
  - MP3 (.mp3)
  - WAV (.wav)
  - OGG (.ogg)
  - M4A (.m4a)
  - AAC (.aac)
  - WebM (.webm)
- **制約**:
  - 最大ファイルサイズ: 10MB
  - アップロード数: 1ファイル/エントリー
- **処理フロー**:
  1. クライアントでファイル選択
  2. バックエンドAPIへアップロード（JWTトークン付き）
  3. サーバー側でファイル保存（`UPLOAD_DIR`配下）
  4. URLをDBに保存
- **アクセス権**: 認証済みユーザー

#### 2.2.5 日付選択（カレンダー）
- **機能ID**: DIARY-005
- **機能名**: カレンダーUIによる日付選択
- **説明**: カレンダーUIを使用して日記の日付を選択できる
- **機能**:
  - 月単位での表示
  - 前月/次月への移動
  - 今日の日付のハイライト
  - 選択中の日付のハイライト
- **アクセス権**: 認証済みユーザー

---

### 2.3 日記閲覧・管理機能

#### 2.3.1 マイ日記一覧表示
- **機能ID**: DIARY-006
- **機能名**: 自分の日記一覧表示
- **説明**: ログインユーザーが自分の日記エントリー一覧を表示できる
- **表示情報**:
  - 日付（フォーマット済み）
  - 天気アイコン
  - メインコンテンツ
  - 詳細項目（10項目）
  - 添付画像（サムネイル）
  - 添付音声（再生コントロール）
  - 公開/非公開ステータス
  - 作成日時
- **ソート順**: 日付降順 → 作成日時降順
- **アクセス権**: 認証済みユーザー（自分の日記のみ）

#### 2.3.2 公開日記一覧表示
- **機能ID**: DIARY-007
- **機能名**: みんなの日記一覧表示
- **説明**: 公開設定された日記エントリーを全ユーザーが閲覧できる
- **表示情報**:
  - 投稿者情報（表示名、プロフィール画像）
  - 日付
  - 天気アイコン
  - メインコンテンツ
  - 詳細項目（10項目）
  - 添付画像
  - 添付音声
- **取得件数**: 最新50件
- **ソート順**: 作成日時降順
- **アクセス権**: 全ユーザー（未認証でも閲覧可能）

#### 2.3.3 日記削除
- **機能ID**: DIARY-008
- **機能名**: 日記エントリー削除
- **説明**: 自分の日記エントリーを削除できる
- **処理内容**:
  1. DBからレコード削除
  2. 添付画像がある場合はファイルサーバーから削除
  3. 添付音声がある場合はファイルサーバーから削除
- **確認**: 削除実行前に確認ダイアログ表示
- **アクセス権**: 認証済みユーザー（自分の日記のみ）

#### 2.3.4 公開設定切り替え
- **機能ID**: DIARY-009
- **機能名**: 日記の公開/非公開切り替え
- **説明**: 既存の日記エントリーの公開設定を変更できる
- **処理内容**:
  - DBの`is_public`フィールド更新
- **アクセス権**: 認証済みユーザー（自分の日記のみ）

---

### 2.4 UI・表示機能

#### 2.4.1 ダークモード
- **機能ID**: UI-001
- **機能名**: ダークモード切り替え
- **説明**: アプリケーション全体のテーマを切り替えられる
- **機能**:
  - ライトモード/ダークモードの切り替え
  - 設定のlocalStorageへの保存
  - ページリロード時の設定復元
- **アクセス権**: 全ユーザー

#### 2.4.2 ナビゲーション
- **機能ID**: UI-002
- **機能名**: ページ切り替えナビゲーション
- **説明**: マイ日記とみんなの日記を切り替えられる
- **ページ**:
  - マイ日記 📝 - 自分の日記の作成・管理（`/diary`）
  - みんなの日記 🌍 - 公開日記の閲覧（`/public`）
- **アクセス権**: 全ユーザー

#### 2.4.3 ユーザープロフィール表示
- **機能ID**: UI-003
- **機能名**: ログインユーザー情報表示
- **説明**: ヘッダーにログインユーザーの情報を表示
- **表示情報**:
  - プロフィール画像（設定している場合）
  - 表示名
  - ログアウトボタン
- **アクセス権**: 認証済みユーザー

---

## 3. 非機能要件（概要）

### 3.1 セキュリティ
- JWTトークンによる認証
- bcryptによるパスワードハッシュ化
- CORS設定による許可オリジン制御（`ALLOWED_ORIGINS`環境変数）
- ファイルアップロード時のバリデーション
- パストラバーサル攻撃対策

### 3.2 パフォーマンス
- 画像の遅延読み込み（Lazy Loading）
- 公開日記は最新50件に制限

### 3.3 可用性
- Dockerコンテナによる環境の再現性確保（devcontainer）
- Airによるホットリロード（開発環境）
- ヘルスチェックエンドポイントによる稼働監視

---

## 4. 制約事項

### 4.1 技術的制約
- フロントエンド: Next.js (App Router) + TypeScript + TailwindCSS v4
- バックエンド: Go + Air
- データベース: PostgreSQL
- 認証: JWT (メールアドレス + パスワード)
- ファイルストレージ: ローカルファイルシステム（`UPLOAD_DIR`環境変数で設定）

### 4.2 運用制約
- ファイルアップロード容量制限（画像: 5MB、音声: 10MB）
- 公開日記表示件数制限（最新50件）

---

## 5. 将来の拡張予定

### 5.1 検討中の機能
- 日記の検索機能
- タグ機能
- コメント機能
- いいね機能
- カテゴリー分類
- エクスポート機能（PDF、テキスト）
- 統計・分析機能（感情の傾向、投稿頻度など）
- プッシュ通知（日記のリマインド）

### 5.2 技術的改善
- 画像・音声のクラウドストレージ移行
- 全文検索エンジンの導入
- PWA対応（オフライン機能）

---

## 6. 用語集

| 用語 | 説明 |
|------|------|
| エントリー | 1つの日記投稿 |
| 公開日記 | is_public=trueに設定された日記 |
| マイ日記 | ログインユーザー自身の日記 |
| 詳細項目 | 10の構造化された入力フィールド |
| JWT | JSON Web Token。認証に使用するトークン形式 |
| Air | Go用のホットリロードツール |

---

**文書作成日**: 2026年2月19日  
**バージョン**: 1.0
